<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:o="http://omnifaces.org/ui">
<h:head>
	<title>Quoting</title>
	<ui:include src="/_includes/_dashboard_header.xhtml" />
</h:head>
<h:body onunload="leavingPage()">
	<h:outputText
		value="#{loginBean.checkAccessRedirectHome(act.pageQuoting)}" />
	<ui:include src="/_includes/top.xhtml" />
	<ui:include src="/_includes/side.xhtml" />
	<div class="w3-container">
		<h:form id="form-g">
			<p:growl id="error-growl" sticky="true"
				rendered="#{facesContext.maximumSeverity.ordinal eq 2}" />
			<p:growl id="success-growl" sticky="true"
				rendered="#{facesContext.maximumSeverity.ordinal eq 0}" />
		</h:form>
		<div class="w3-row w3-container w3-padding-16">
			<div align="left" class="w3-third" style="padding-left: 20px">
				<h:form>
					<p:commandButton value="Assign New"
						actionListener="#{liveQuotingBean.requestAssignment()}"
						styleClass="q-btn" update=":form-g" />
				</h:form>
			</div>
			<div align="center" class="w3-third">
				<h:outputText value="Quotations" styleClass="q-large-text" />
			</div>
			<div align="right" class="w3-third">
				<h:outputText value="Month Score: #{liveQuotingBean.positiveScore}"
					styleClass="q-bold w3-text-green" />
				<br />
				<h:outputText value="Month Deductions: #{liveQuotingBean.negativeScore}"
					styleClass="q-bold w3-text-red" />
			</div>
		</div>
		<div class="w3-container">
			<div class="w3-row">
				<h:panelGroup id="repeat-panel">
					<ui:repeat id="repeat" var="quotation" value="#{liveQuotingBean.quotations}">
						<div class="w3-container" id="c#{quotation.id}">
							<div class="w3-card-4">
								<header class="w3-container w3-camo-dark-grey w3-padding-8">
								<div class="w3-container">
									<div align="center" class="q-med-text">
										<h:outputText value="Quotation # #{quotation.id}" />
										<h:form>
											<p:commandButton value="Unassign"
												actionListener="#{liveQuotingBean.unassign(quotation.id)}"
												styleClass="q-btn-red" update=":form-g" />
										</h:form>
									</div>
									<div class="w3-row">
										<div class="w3-col m12 l4 q-bold" align="left">
											<h:outputText value="#{makesBean.getModelYearFromId(quotation.customerVehicle.vehicleYearId).fullName}" />
										</div>
										<div class="w3-col m12 l4 q-bold" align="center">
											<h:outputText
												value="#{quotation.cityId}" />
										</div>
										<div class="w3-col m12 l4 q-bold" align="right">
											<h:outputText value="#{quotation.customerVehicle.vin}" />
										</div>
									</div>
								</div>
								</header>
								<div class="w3-container">
									<br/>
									<p:panel toggleable="true" header="Order Details" collapsed="true"
										toggleSpeed="100">
										<div class="w3-row">
										<div class="w3-col s12 l6">
											<h:panelGrid columns="2">
												<h:outputText value="ID" />
												<h:inputText value="#{quotation.customer.id}" readonly="true" />
												<h:outputText value="Name" />
												<h:inputText value="#{quotation.customer.fullName}"
													readonly="true" />
												<h:outputText value="Mobile" />
												<h:inputText value="#{quotation.customer.email}" readonly="true" />
												<h:outputText value="Email" />
												<h:inputText value="#{quotation.customer.email}" readonly="true" />
											</h:panelGrid>
										</div>
										<div class="w3-col s12 l6">
											<h:dataTable value="#{quotation.quotationItems}" var="item"
												styleClass="w3-table w3-striped w3-border"
												headerClass="w3-border-bottom w3-light-grey">
												<f:facet name="header">
													<h:outputText value="Quotation Items" />
												</f:facet>
												<h:column>
													<f:facet name="header">
														<h:outputText value="Item Name" />
													</f:facet>
													<h:outputText value="#{item.name}" />
												</h:column>
												<h:column>
													<f:facet name="header">
														<h:outputText value="Quantity" />
													</f:facet>
													<h:outputText value="#{item.quantity}" />
												</h:column>
												<h:column>
													<f:facet name="header">
														<div align="center">
															<h:outputText value="Image"/>
														</div>
													</f:facet>
													<div align="center">
														<h:graphicImage value="#{item.getImageLink(quotation.created)}" width="50" rendered="false"/>
													</div>
												</h:column>
											</h:dataTable>
										</div>
										</div>
									</p:panel>
									<br />
									<p:panel toggleable="true"
										header="Comments (#{quotation.comments.size()})" collapsed="true"
										toggleSpeed="100">
										<div class="w3-row">
											<div class="w3-col m12 w3-padding">
												<h:panelGroup id="review-panel">
													<h:outputText value="All Comments:" styleClass="q-bold" />
													<br />
													<div class="w3-container">
														<ui:repeat var="comment" value="#{quotation.comments}">
															<h:outputText value="#{comment.created}"
																styleClass="q-bold" style="color:#2dacd1!important;">
																<f:convertDateTime pattern="dd-MMM-yyyy hh:mm" />
															</h:outputText>
															<h:outputText
																value=" #{usersBean.getUserFromId(comment.createdBy).idWithName}: "
																styleClass="q-bold" style="color:#2dacd1!important;" />
															<h:outputText
																value=" (#{comment.visibleToCustomer ? 'visible' : 'hidden'}) : "
																style="color:#2dacd1!important;" styleClass="q-bold" />
															<h:outputText dir="RTL" value=" #{comment.text}" />
															<br />
														</ui:repeat>
													</div>
												</h:panelGroup>
											</div>
											<div class="w3-col m12 w3-padding">
												<h:form>
													<h:outputText value="New Comment:" styleClass="q-bold" />
													<div class="w3-container">
														<h:panelGrid columns="1">
															<h:inputText value="#{quotation.newComment.text}" required="true">
																<f:ajax/>
															</h:inputText>
															<h:panelGroup>
																<h:selectBooleanCheckbox value="#{quotation.newComment.visibleToCustomer}">
																	<f:ajax/>
																</h:selectBooleanCheckbox>
																<h:outputText value="Visible to Customer" />
															</h:panelGroup>
														</h:panelGrid>
														<p:commandButton value="Add Comment" styleClass="q-btn"
															actionListener="#{liveQuotingBean.submitNewComment(quotation)}"
															ajax="false" process="@form" />
													</div>
												</h:form>
											</div>
										</div>
									</p:panel>
								</div>


								<div class="w3-container">
									<br />
									<p:panel toggleable="true"
										header="Bill Items (#{quotation.allBillItems.size()})"
										collapsed="false" toggleSpeed="100">
										<div align="center">
											<h:outputText value="Bill Items Items"
												styleClass="q-bold q-med-text" />
										</div>
										<div align="center" class="w3-padding-8">
											<p:commandButton value="+New Bill Item" styleClass="q-btn"
												oncomplete="PF('dlg5wv').show()"
												actionListener="#{liveQuotingBean.chooseNewBillItem(quotation)}"
												update=":form5" />
										</div>
										<h:form>
											<div class="w3-row">
												<ui:repeat var="billItem" value="#{quotation.allBillItems}">
													<div class="w3-container w3-col m12 l4 w3-padding">
														<div class="w3-card-2 w3-border">
															<div align="center">
																<h:panelGroup layout="block"
																	styleClass="w3-pannel w3-green w3-padding w3-contrainer"
																	rendered="#{billItem.status eq 'C'}">
																	<h:outputText value="Completed" />
																</h:panelGroup>

																<h:panelGroup layout="block"
																	styleClass="w3-pannel w3-red w3-padding w3-contrainer"
																	rendered="#{billItem.status eq 'N'}">
																	<h:outputText value="Not Available" />
																</h:panelGroup>

																<h:panelGroup layout="block"
																	styleClass="w3-pannel w3-blue w3-padding w3-contrainer"
																	rendered="#{billItem.status eq 'W'}">
																	<h:outputText value="Waiting" />
																</h:panelGroup>
															</div>
															<div class="w3-container ">
																<br />
																<h:panelGroup>
																	<h:panelGrid columns="2">
																		<h:outputText value="Edit" />
																		<h:selectBooleanCheckbox value="#{billItem.edit}">
																			<f:ajax execute="@this" render="repeat-panel"/>
																		</h:selectBooleanCheckbox>
																	</h:panelGrid>
																</h:panelGroup>

																<h:panelGrid columns="2"
																	styleClass="w3-table w3-striped w3-border">
																	<h:outputText value="Description" />
																	<h:outputText value="#{billItem.itemDesc}"
																		rendered="#{not billItem.edit}" styleClass="q-bold" />
																	<h:inputText value="#{billItem.itemDesc}"
																		rendered="#{billItem.edit}" required="true"
																		requiredMessage="Enter item description"
																		styleClass="q-bold">
																		<f:ajax />
																	</h:inputText>
																	<h:outputText value="Qty." />
																	<h:outputText value="#{billItem.quantity}"
																		rendered="#{not billItem.edit}" />
																	<h:inputText value="#{billItem.quantity}"
																		rendered="#{billItem.edit}" required="true"
																		requiredMessage="Enter quantity">
																		<f:ajax />
																	</h:inputText>
																	<h:outputText value="Not Available"
																		rendered="#{not billItem.hasSavedResponse() and not billItem.edit}" />
																	<h:selectBooleanCheckbox value="#{billItem.notAvailable}"
																		rendered="#{not billItem.hasSavedResponse() and not billItem.edit}">
																		<f:ajax render="repeat-panel" listener="#{billItem.chooseNotAvailable()}" execute="@this"/>
																	</h:selectBooleanCheckbox>
																</h:panelGrid>

																<br />
																<div align="center">
																	<p:commandButton styleClass="q-btn"
																		rendered="#{not billItem.notAvailable and billItem.billItemResponses.size() eq 0 and (not billItem.edit)}"
																		actionListener="#{liveQuotingBean.chooseBillItem(billItem)}"
																		value="+" oncomplete="PF('dlg3wv').show()"
																		update=":form3" />

																	<p:commandButton styleClass="q-btn"
																		rendered="#{billItem.edit}"
																		actionListener="#{liveQuotingBean.saveEdit(billItem)}"
																		value="Save Edit" update="repeat-panel :form-g" />
																</div>
																<h:dataTable value="#{billItem.billItemResponses}"
																	var="biresponse" styleClass="w3-table w3-striped w3-border"
																	headerClass="w3-light-grey w3-border-bottom"
																	rendered="#{billItem.billItemResponses.size() gt 0}">
																	<f:facet name="header">
																		<div align="center">
																			<h:outputText value="Bill Responses" />
																		</div>
																	</f:facet>
																	<h:column>
																		<f:facet name="header">
																			<h:outputText value="Number" />
																		</f:facet>
																		<h:outputText value="#{biresponse.productHolder.product.productNumber}"
																			rendered="#{not (biresponse.status eq 'N')}" />
																		<h:outputText value="N/A"
																			rendered="#{(biresponse.status eq 'N')}" />
																	</h:column>
																	<h:column>
																		<f:facet name="header">
																			<h:outputText value="Price" />
																		</f:facet>
																		<h:outputText value="#{biresponse.productHolder.productPrices.get(0).price}"
																			rendered="#{biresponse.status eq 'C'}">
																			<f:convertNumber currencySymbol="SR " type="currency" />
																		</h:outputText>
																		<p:commandLink value="Complete"
																			styleClass="w3-tag w3-orange w3-text-white q-tag-padding"
																			rendered="#{res.status eq 'I'}"
																			oncomplete="PF('dlg4wv').show()" update=":form4"
																			actionListener="#{quotingBean.chooseQuotationItemResponse(res)}" />
																		<h:outputText value="N/A"
																			rendered="#{(biresponse.status eq 'N')}" />
																	</h:column>
																	<h:column>
																		<f:facet name="header">
																			<h:outputText value="Remove" />
																		</f:facet>
																		<p:commandButton styleClass="q-btn-red" value="X"
																			actionListener="#{quotingBean.removeResponse(res, qi)}"
																			update=":repeat-panel" execute="@this"
																			rendered="#{not (res.status eq 'N') and not (qi.status eq 'C')}" />
																	</h:column>
																</h:dataTable>
																<div align="center">
																	<br />
																	<p:commandButton styleClass="q-btn-indigo" value="Save"
																		disabled="#{not billItem.notAvailable and billItem.billItemResponses.size() eq 0}"
																		actionListener="#{liveQuotingBean.saveResponse(billItem)}"
																		process="@this" update=":form-g"
																		rendered="#{not (billItem.status eq 'N') and not (billItem.status eq 'C') and not billItem.edit}" />
																</div>
															</div>
															<br />
														</div>
													</div>
												</ui:repeat>
											</div>
										</h:form>
									</p:panel>
									<br />
								</div>
							</div>
							<br /> <br />
						</div>
					</ui:repeat>
				</h:panelGroup>

				<h:form id="form3">
					<p:dialog styleClass="q-dialog" header="Add Product" position="top"
						widgetVar="dlg3wv">
						<h:panelGrid columns="2" id="search-panel">
							<h:outputText value="Description" />
							<h:outputText
								value="#{liveQuotingBean.selectedBillItem.itemDesc}" />
							<h:outputText value="Enter Part Number" />
							<h:inputText value="#{liveQuotingBean.searchPartNumber}" required="true"
								id="part-number" />
							<h:outputText value="Select Brand"/>
							<h:selectOneMenu id="brand-id" value="#{liveQuotingBean.searchBrandId}" requiredMessage="Select brand" required="true" >
								<f:selectItem noSelectionOption="true" itemLabel="--Select Brand--"/>
								<f:selectItems
										value="#{makesBean.getMakeFromId(liveQuotingBean.quotationFromSelectedBillItem.makeId).brands}"
										var="brand" itemLabel="#{brand.name}" itemValue="#{brand.id}"/>
							</h:selectOneMenu>
						</h:panelGrid>
						<div align="center">
							<p:commandButton styleClass="q-btn"
								actionListener="#{liveQuotingBean.findProduct()}" value="Search / Create"
								process="@this part-number brand-id" update="found :form-g" />
						</div>
						<br />
						<h:panelGroup id="found">
							<h:outputText value="#{liveQuotingBean.productHolder  eq null}" />
							<h:panelGrid columns="2"
								styleClass="w3-table w3-striped w3-border"
								rendered="#{not (liveQuotingBean.productHolder.product eq null)}">
								<h:outputText value="Product Number" />
								<h:outputText value="#{liveQuotingBean.productHolder.product.productNumber}" />
								<h:outputText value="Product Name" />
								<h:outputText value="#{liveQuotingBean.productHolder.product.desc}" />
								<h:outputText value="Brand" />
								<h:outputText value="#{liveQuotingBean.productHolder.product.brand.name}" />
							</h:panelGrid>

							<h:dataTable value="#{liveQuotingBean.productHolder.productPrices}"
								var="price" styleClass="w3-table w3-striped w3-border"
								rendered="#{not (liveQuotingBean.productHolder.productPrices eq null) and (not (liveQuotingBean.productHolder.productPrices.isEmpty()))}"
								headerClass="w3-light-grey w3-border-bottom">
								<h:column>
									<f:facet name="header">
										<h:outputText value="Price" />
									</f:facet>
									<h:outputText value="#{price.price}" />
								</h:column>
								<h:column>
									<f:facet name="header">
										<h:outputText value="Vendor" />
									</f:facet>
									<h:outputText
										value="#{vendorsBean.getVendorFromId(price.vendorId).name}" />
								</h:column>
								<h:column>
									<f:facet name="header">
										<h:outputText value="Select Price" />
									</f:facet>
									<p:commandButton
											actionListener="#{liveQuotingBean.selectPrice(price)}"
											update=":form-g :repeat-panel" styleClass="q-btn"
											value="Select" oncomplete="PF('dlg3wv').hide()" />
								</h:column>
							</h:dataTable>
							<h:outputText value="New Price " />
							<h:selectBooleanCheckbox value="#{liveQuotingBean.newPrice}">
								<f:ajax execute="@this" render="new-price-panel"></f:ajax>
							</h:selectBooleanCheckbox>
							<h:panelGroup id="new-price-panel">
								<h:panelGrid rendered="#{liveQuotingBean.newPrice}" columns="2" styleClass="w3-table w3-striped">
									<h:outputText value="Price" />
									<h:inputText value="#{liveQuotingBean.productPrice.price}"
										required="true" />
									<h:outputText value="Vat Included?" />
									<h:selectBooleanCheckbox
										value="#{liveQuotingBean.productPrice.vatIncluded}" />
									<h:outputText value="Vendor" />
									<p:autoComplete placeholder="Type Vendor name" id="vendorCustom"
													maxResults="10"
													styleClass="q-auto-complete" required="true"
													value="#{liveQuotingBean.productPrice.vendorId}" dropdown="true"
													completeMethod="#{vendorsBean.completeVendorIds}" var="b"
													itemLabel="#{vendorsBean.getVendorFromId(b).name}"
													itemValue="#{vendorsBean.getVendorFromId(b).id}"
													forceSelection="true" style="width: 100%!important;">
										<p:ajax/>
									</p:autoComplete>
								</h:panelGrid>
								<p:commandButton value="Add New Price"
									rendered="#{liveQuotingBean.newPrice}" styleClass="q-btn"
									actionListener="#{liveQuotingBean.updateNewPrice(liveQuotingBean.productHolder.product)}"
									process="new-price-panel @this" update="found :form-g"/>
							</h:panelGroup>
						</h:panelGroup>
					</p:dialog>
				</h:form>
				<h:form id="form4">
					<p:dialog widgetVar="dlg4wv" styleClass="q-dialog"
						header="Complete Pricing">
						<h:panelGroup id="found">
							<h:panelGrid columns="2" styleClass="w3-table w3-striped">
								<h:outputText value="Product" />
								<h:outputText
									value="#{quotingBean.selectedQuotationItemResponse.product.productNumber}" />
							</h:panelGrid>
							<h:dataTable
								value="#{quotingBean.selectedQuotationItemResponse.product.priceList}"
								var="price" styleClass="w3-table w3-striped w3-border"
								rendered="#{quotingBean.selectedQuotationItemResponse.product.id gt 0}"
								headerClass="w3-light-grey w3-border-bottom">
								<f:facet name="header">
									<div align="center">
										<h:outputText value="Vendor Prices" />
									</div>
								</f:facet>
								<h:column>
									<f:facet name="header">
										<h:outputText value="Price" />
									</f:facet>
									<h:outputText value="#{price.costPriceWv}" />
								</h:column>
								<h:column>
									<f:facet name="header">
										<h:outputText value="Vendor" />
									</f:facet>
									<h:outputText
										value="#{vendorBean.getVendorFromId(price.vendorId).name}" />
								</h:column>
								<h:column>
									<f:facet name="header">
										<h:outputText value="Select Price" />
									</f:facet>
									<p:commandButton
										actionListener="#{quotingBean.selectPriceComplete(price)}"
										update=":form-g :repeat-panel" styleClass="q-btn"
										value="Select" oncomplete="PF('dlg4wv').hide()" />
								</h:column>

							</h:dataTable>
							<h:outputText value="New Price " />
							<h:selectBooleanCheckbox value="#{quotingBean.newPrice}">
								<f:ajax execute="@this" render="new-price-panel2"></f:ajax>
							</h:selectBooleanCheckbox>
							<h:panelGroup id="new-price-panel2">
								<h:panelGrid rendered="#{quotingBean.newPrice}" columns="2"
									styleClass="w3-table w3-striped">
									<h:outputText value="Price" />
									<h:inputText
										value="#{quotingBean.incompleteProductPrice.costPrice}"
										required="true" />
									<h:outputText value="Vat Included?" />
									<h:selectBooleanCheckbox
										value="#{quotingBean.incompleteProductPrice.vatIncluded}" />
									<h:outputText value="Vendor" />
									<h:selectOneMenu
										value="#{quotingBean.incompleteProductPrice.vendorId}">
										<f:selectItems
											value="#{vendorBean.getMakeVendors(quotingBean.cartFromSelectedQuotationItemResponse.makeId)}"
											var="vendor" itemLabel="#{vendor.name}"
											itemValue="#{vendor.id}" />
									</h:selectOneMenu>
								</h:panelGrid>
								<p:commandButton value="Add New Price"
									rendered="#{quotingBean.newPrice}" styleClass="q-btn"
									actionListener="#{quotingBean.updateNewPrice(quotingBean.incompleteProductPrice, quotingBean.selectedQuotationItemResponse.product, true)}"
									process="new-price-panel2 @this" update="found :form-g"/>
							</h:panelGroup>
						</h:panelGroup>
					</p:dialog>
				</h:form>

				<h:form id="form5">
					<p:dialog id="dlg5" widgetVar="dlg5wv" styleClass="q-dialog" header="New Bill Item">
						<h:panelGrid columns="2"
							styleClass="w3-table w3-striped w3-border">
							<h:outputText value="Quotation ID" />
							<h:outputText value="#{liveQuotingBean.newBillItem.quotationId}" />
							<h:outputText value="Description" />
							<h:inputText value="#{liveQuotingBean.newBillItem.itemDesc}"
								required="true" requiredMessage="Enter Item Name" />
							<h:outputText value="Quantity" />
							<h:selectOneMenu value="#{liveQuotingBean.newBillItem.quantity}"
								required="true">
								<f:selectItem itemValue="#{1}" itemLabel="1" />
								<f:selectItem itemValue="#{2}" itemLabel="2" />
								<f:selectItem itemValue="#{3}" itemLabel="3" />
								<f:selectItem itemValue="#{4}" itemLabel="4" />
								<f:selectItem itemValue="#{5}" itemLabel="5" />
								<f:selectItem itemValue="#{6}" itemLabel="6" />
								<f:selectItem itemValue="#{7}" itemLabel="7" />
								<f:selectItem itemValue="#{8}" itemLabel="8" />
								<f:selectItem itemValue="#{9}" itemLabel="9" />
								<f:selectItem itemValue="#{10}" itemLabel="10" />
								<f:selectItem itemValue="#{11}" itemLabel="11" />
								<f:selectItem itemValue="#{12}" itemLabel="12" />
								<f:selectItem itemValue="#{13}" itemLabel="13" />
								<f:selectItem itemValue="#{14}" itemLabel="14" />
								<f:selectItem itemValue="#{15}" itemLabel="15" />
								<f:selectItem itemValue="#{16}" itemLabel="16" />
								<f:selectItem itemValue="#{17}" itemLabel="17" />
								<f:selectItem itemValue="#{18}" itemLabel="18" />
								<f:selectItem itemValue="#{19}" itemLabel="19" />
								<f:selectItem itemValue="#{20}" itemLabel="20" />
							</h:selectOneMenu>
						</h:panelGrid>
						<div align="center">
							<p:commandButton value="Create Bill Item" styleClass="q-btn"
								actionListener="#{liveQuotingBean.createNewBillItem}"
								update=":form-g repeat-panel" oncomplete="PF('dlg52v').hide()" />
						</div>
					</p:dialog>
				</h:form>

				<h:form>
					<o:socket channel="quotingChannel" onmessage="updateQuotations" scope="view" />
					<p:remoteCommand name="updateQuotations"
						update=":repeat-panel :form-g" />
				</h:form>
			</div>
		</div>
	</div>
</h:body>
</html>
